//memba
#include <Adafruit_Fingerprint.h>
#include <Arduino.h>
Adafruit_Fingerprint finger = Adafruit_Fingerprint(&Serial2);

void setup()
{
  Serial2.begin(57600, SERIAL_8N1, 16, 17);
  Serial.begin(57600);
  delay(100);
  Serial.println("\n\ Picture Taker and Uploader");
  finger.begin(57600);//Unless you change using an internal command, you must use this rate

  if (finger.verifyPassword()) {
    Serial.println("Authenticated!");
  } else {
    Serial.println("Unauthenticated :(");
    while (1) { delay(1); }
  }

  Serial.println(F("Reading sensor parameters"));
  finger.getParameters();
  Serial.print(F("Status: 0x")); Serial.println(finger.status_reg, HEX);
  Serial.print(F("Sys ID: 0x")); Serial.println(finger.system_id, HEX);
  Serial.print(F("Capacity: ")); Serial.println(finger.capacity);
  Serial.print(F("Security level: ")); Serial.println(finger.security_level);
  Serial.print(F("Device address: ")); Serial.println(finger.device_addr, HEX);
  Serial.print(F("Packet len: ")); Serial.println(finger.packet_len);
  Serial.print(F("Baud rate: ")); Serial.println(finger.baud_rate);
}

uint8_t readnumber(void) {
  uint8_t num = 0;

  while (num == 0) {
    while (! Serial.available());
    num = Serial.parseInt();
  }
  return num;
}

void loop()                  
{
  Serial.println("Input number to register model as:");
  UploadModel(readnumber());
  delay(50);
}

uint8_t UploadModel(int i) {
  int i2=0;
  unsigned char data[512]={0x03,0x03,0x51,0x19,0x18,0x01,0x4E,0x01,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x8D,0x00,0x30,0x03,0xCF,0xC0,0xFF,0xFF,0xF0,0x0C,0xCF,0xEF,0xAE,0xBF,0xFB,0xAE,0xEE,0xBA,0xEE,0xFB,0xAB,0xAA,0x65,0x56,0x66,0x56,0x55,0x55,0x56,0x55,0x55,0x15,0x11,0x44,0x04,0x40,0x04,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x14,0xE4,0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x02,0x00,0x82,0x3D,0x17,0xEC,0xFE,0x1E,0xA6,0x0F,0x7E,0x37,0x2B,0x29,0xBE,0x5E,0x37,0x88,0xDE,0x14,0xC0,0x50,0xFE,0x27,0x93,0x2A,0xDF,0x45,0x9E,0xC0,0xFF,0x25,0x23,0x68,0xFF,0x2A,0xAA,0x67,0x1F,0x3F,0xAB,0xEC,0x3C,0x34,0x21,0xD1,0xDD,0x33,0x25,0x0F,0x3D,0x55,0xA6,0x02,0xFD,0x44,0x2F,0x81,0xDD,0x19,0xB8,0x8E,0x3A,0x18,0x3A,0xE4,0xBA,0x2C,0xBF,0xCC,0x7A,0x31,0x41,0x22,0x7B,0x5C,0x26,0x98,0x38,0x40,0xB8,0xA3,0x78,0x42,0x34,0xCE,0x19,0x63,0x28,0x05,0x56,0x34,0x89,0x2B,0x9F,0x59,0x9D,0xD8,0xF3,0x5B,0x1E,0xDA,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0xC6,0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x02,0x00,0x82,0x3B,0x0F,0x00,0x1E,0x1A,0x9B,0xCF,0x9E,0x32,0x21,0xE9,0xDE,0x56,0xB0,0x08,0xFE,0x0C,0x35,0x91,0x1E,0x26,0x89,0x6A,0xFF,0x42,0x96,0x41,0x1F,0x21,0x99,0x69,0x1F,0x25,0xA0,0xA7,0x3F,0x3A,0x23,0x2C,0x5C,0x30,0x98,0x91,0xFD,0x2F,0x1B,0xCF,0x5D,0x51,0x1E,0x43,0x1D,0x3E,0x27,0x01,0xFD,0x12,0x2E,0x0E,0x5A,0x10,0x30,0x64,0xDA,0x24,0x36,0x0C,0x9A,0x28,0x37,0xA2,0x9B,0x57,0x9F,0x18,0x58,0x39,0x2F,0xE3,0x98,0x3B,0x2C,0x0E,0x39,0x5E,0x20,0xC5,0x76,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xB6,0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x08,0x00,0x82,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01};
  unsigned char dataPacket[]={0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x00,0x82};
  unsigned char IDPacket[]={0x02,0x08};
  unsigned char checksum[]={0x00,0x84,0x00,0x90};//0x02+0x00+0x82+0x00=0x84        //0x08+0x00+0x82+0x00=0x90
  Serial.print("Attempting to send Model\n");
  uint32_t starttime = millis();
  int  p = finger.DownloadVirus(i);
  if (p == FINGERPRINT_OK){
    for(int i1=0;i1<4&&(millis()-starttime)<20000;i1++) {//1024 characters/2=512bytes/128=      4 packets
      if (Serial2.availableForWrite()) { //I may lose some bytes here-It's inevitable
        Serial2.write(dataPacket[0]);
        Serial2.write(dataPacket[1]);
        Serial2.write(dataPacket[2]);
        Serial2.write(dataPacket[3]);
        Serial2.write(dataPacket[4]);
        Serial2.write(dataPacket[5]);
        if(i1==4){Serial2.write(IDPacket[1]);}
        else{Serial2.write(IDPacket[0]);}
        Serial2.write(dataPacket[6]);
        Serial2.write(dataPacket[7]);
        do{
          //Serial.print(data[i2], HEX);    //Uncomment to see what's being sent through
          Serial2.write(data[i2]);
          i2++;
        }
        while(i2%128!=0);      
        if(i1==4){
          Serial2.write(checksum[2]);
          Serial2.write(checksum[3]);
        }
        else{
          Serial2.write(checksum[0]);
          Serial2.write(checksum[1]);
        }
      }
    //yield();//Watch dog Schenanigans
    delay(30);
    }
  }
  printf("That's the end\n");
  return true;
}
