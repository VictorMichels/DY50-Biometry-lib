//memba
#include <Adafruit_Fingerprint.h>
#include <Arduino.h>
Adafruit_Fingerprint finger = Adafruit_Fingerprint(&Serial2);

void setup()
{
  Serial2.begin(57600, SERIAL_8N1, 16, 17);
  Serial.begin(57600);
  delay(100);
  Serial.println("\n\ Picture Taker and Uploader");
  finger.begin(57600);//Unless you change using an internal command, you must use this rate

  if (finger.verifyPassword()) {
    Serial.println("Authenticated!");
  } else {
    Serial.println("Unauthenticated :(");
    while (1) { delay(1); }
  }

  Serial.println(F("Reading sensor parameters"));
  finger.getParameters();
  Serial.print(F("Status: 0x")); Serial.println(finger.status_reg, HEX);
  Serial.print(F("Sys ID: 0x")); Serial.println(finger.system_id, HEX);
  Serial.print(F("Capacity: ")); Serial.println(finger.capacity);
  Serial.print(F("Security level: ")); Serial.println(finger.security_level);
  Serial.print(F("Device address: ")); Serial.println(finger.device_addr, HEX);
  Serial.print(F("Packet len: ")); Serial.println(finger.packet_len);
  Serial.print(F("Baud rate: ")); Serial.println(finger.baud_rate);
}

uint8_t readnumber(void) {
  uint8_t num = 0;

  while (num == 0) {
    while (! Serial.available());
    num = Serial.parseInt();
  }
  return num;
}

void loop()                  
{
  Serial.println("Input number to register model as:");
  UploadModel(readnumber());
  delay(50);
}

uint8_t UploadModel(int i) {
  int i2=0;
  unsigned char data[512]={0x03,0x03,0x5E,0x1B,0x08,0x01,0x26,0x01,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x01,0x00,0x83,0x00,0x00,0x00,0x00,0x03,0x0C,0x0F,0x3C,0xCC,0xF3,0xF3,0x3F,0xFF,0xEF,0xEE,0xFB,0xFB,0xAB,0xAE,0xAA,0xAA,0xAA,0xA9,0x9A,0x65,0x59,0x55,0x55,0x55,0x55,0x55,0x55,0x10,0x40,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x12,0x1B,0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x02,0x00,0x82,0x42,0x8D,0x00,0xFE,0x56,0x8D,0x97,0xFE,0x4A,0x13,0xC1,0xDE,0x5B,0x25,0x87,0xBE,0x76,0xA6,0x86,0xBE,0x1B,0xAA,0x4E,0x9E,0x5B,0x2B,0x48,0xBE,0x66,0x3C,0x8B,0xFE,0x53,0x1C,0x84,0xFF,0x27,0xA1,0x67,0xBF,0x13,0x2F,0x25,0x7F,0x51,0xAE,0x8A,0x1F,0x4E,0xB9,0xCC,0xBF,0x34,0x98,0x52,0x7A,0x22,0x99,0x10,0x9A,0x33,0x9B,0x11,0x9A,0x27,0x18,0x69,0xBB,0x3B,0x2B,0x28,0xDB,0x35,0xA0,0xEA,0x58,0x42,0x2C,0x87,0xB8,0x41,0xA5,0xC4,0x19,0x48,0x32,0x9F,0x19,0x42,0xB2,0xCC,0x79,0x39,0x21,0xAC,0x57,0x3E,0xA6,0x4F,0xF7,0x42,0xAF,0x12,0xB5,0x40,0xB0,0x8B,0xD5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x31,0x15,0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x02,0x00,0x82,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x84,0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x02,0x00,0x82,0x03,0x03,0x5B,0x1B,0x00,0x01,0x20,0x01,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x83,0x00,0x30,0x0C,0x33,0x33,0x3C,0xCF,0x3F,0x3F,0xCF,0xFB,0xFF,0xBE,0xFF,0xAA,0xBB,0xAA,0xAA,0xAA,0xAA,0x6A,0x95,0x56,0x55,0x55,0x55,0x55,0x55,0x55,0x10,0x44,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  unsigned char dataPacket[]={0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x00,0x82};
  unsigned char InstructionPacket[]={0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0x04,0x09,i,0x00,0x0F};
  unsigned char IDPacket[]={0x02,0x08};
  unsigned short checksomething=0x0082;
  Serial.print("Attempting to send Model\n");
  uint32_t starttime = millis();
  for (int x=0;x<13;x++){Serial2.write(InstructionPacket[x]);}//Instructions 
  delay(10);
    for(int i1=0;i1<4&&(millis()-starttime)<20000;i1++) {//1024 characters/2=512bytes/128= 4 packets
      if (Serial2.availableForWrite()) { //I may lose some bytes here-It's inevitable
        Serial2.write(dataPacket[0]);
        Serial2.write(dataPacket[1]);
        Serial2.write(dataPacket[2]);
        Serial2.write(dataPacket[3]);
        Serial2.write(dataPacket[4]);
        Serial2.write(dataPacket[5]);
        if(i1==3){Serial2.write(IDPacket[1]);}
        else{Serial2.write(IDPacket[0]);}
        Serial2.write(dataPacket[6]);
        Serial2.write(dataPacket[7]);
        do{
          //=Serial.print(data[i2], HEX);    //Uncomment to see what's being sent through
          Serial2.write(data[i2]);
          checksomething+=data[i2];
          i2++;
        }
        while(i2%128!=0);      
        if(i1==3){checksomething+=8;}
        else{checksomething+=2;}
          Serial2.write((uint8_t)(checksomething >> 8));
          Serial2.write((uint8_t)(checksomething & 0xFF));
      }
    //yield();//Watch dog Schenanigans
    delay(30);
    checksomething=0x0082;
    }
  printf("And now save!\n");
  //unsigned char Mergepacket[]={
  int checksave=14+i;
  unsigned char savePacket[]={0xEF,0x01,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0x06,0x06,0x01,(uint8_t)(i>>8),(uint8_t)(i&0xFF),(uint8_t)(checksave>>8),(uint8_t)(checksave&0xFF)};
  for (i=0;i<15;i++){
    Serial2.write(savePacket[i]);
  }
  printf("That's the end\n");
  return true;
}
